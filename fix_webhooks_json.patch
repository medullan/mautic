From 672d68e21e619e1bf3200171e00055967f1a44ba Mon Sep 17 00:00:00 2001
From: Mohammad Abu Musa <m.abumusa@gmail.com>
Date: Mon, 8 Jun 2020 10:30:02 +0300
Subject: [PATCH] 	modified:  
 app/bundles/WebhookBundle/Helper/CampaignHelper.php

---
 .../WebhookBundle/Helper/CampaignHelper.php   | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/app/bundles/WebhookBundle/Helper/CampaignHelper.php b/app/bundles/WebhookBundle/Helper/CampaignHelper.php
index 08ca7050c..3d3d24941 100644
--- a/app/bundles/WebhookBundle/Helper/CampaignHelper.php
+++ b/app/bundles/WebhookBundle/Helper/CampaignHelper.php
@@ -121,7 +121,17 @@ class CampaignHelper
             case 'post':
             case 'put':
             case 'patch':
-                $response = $this->connector->$method($url, $payload, $headers, $timeout);
+                /*
+                    //Patch: Accept JSON Content in Campaigns
+                */
+                $headers = array_change_key_case($headers);
+                //if no content-type is defined, default to application/json and encode body
+                if(!array_key_exists('content-type', $headers) || $headers['content-type'] == 'application/json' ){
+                    $headers['content-type'] = 'application/json';
+                    $payload = json_encode($payload);                    
+                }
+            
+                $response = $this->connector->$method($url, $payload, $headers, $timeout);                
                 break;
             case 'delete':
                 $response = $this->connector->delete($url, $headers, $timeout, $payload);
@@ -129,9 +139,10 @@ class CampaignHelper
             default:
                 throw new \InvalidArgumentException('HTTP method "'.$method.' is not supported."');
         }
-
-        if (!in_array($response->code, [200, 201])) {
-            throw new \OutOfRangeException('Campaign webhook response returned error code: '.$response->code);
+        
+        //Just append the body of the response for debugging purposes
+        if (!in_array($response->code, [200, 201])) {        
+            throw new \OutOfRangeException("Campaign webhook response returned error code: {$response->code} \n Error Message: {$response->body}");
         }
     }
 
-- 
2.17.1

